name: CI & Deploy

on:
  workflow_dispatch:  # Run manually for testing
  push:
    branches:
      - main

jobs:
  create-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/deployments \
            -d '{"ref":"${{ github.sha }}","environment":"production","auto_merge":false}'

  set-deployment-status:
    runs-on: ubuntu-latest
    needs: create-deployment
    steps:
      - name: Simulate Deployment Failure
        run: |
          echo "Simulating a deployment failure..."
          exit 1
      - name: Set Deployment Status
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEPLOYMENT_ID=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/deployments | jq -r '.[0].id')
          curl -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
            -d '{"state":"failure","description":"Deployment failed in workflow"}'
